<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ‰¾æ‰¾èŠ’æœå®¶æ—ï½çœ‹ä½ èªå¾—å¹¾å€‹ï¼ğŸ‹</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* ä½¿ç”¨ Tailwind CSS ç°¡åŒ–æ¨£å¼ï¼Œä¸¦å¢åŠ  Inter å­—é«” */
    body { font-family: "Inter", Arial, sans-serif; }
    /* è‡ªå®šç¾©æŒ‰éˆ•å‹•ç•« */
    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(255, 127, 80, 0.4);
    }
    button:active {
        transform: translateY(0);
        box-shadow: none;
    }
    /* éŠæˆ²èªªæ˜å€å¡Šçš„è‡ªè¨‚æ¨£å¼ */
    .game-rules {
        border-left: 5px solid #F97316; /* æ©™è‰²é‚Šæ¢ */
        background-color: #FEF3C7; /* æ·ºé»ƒè‰²èƒŒæ™¯ */
    }
    /* ä¸‹æ‹‰é¸å–®çš„æ¨£å¼èª¿æ•´ï¼Œç¢ºä¿æ‰‹æ©Ÿé»æ“Šç¯„åœèˆ’é© */
    #answer_select {
        appearance: none; /* ç§»é™¤ç€è¦½å™¨é è¨­æ¨£å¼ */
        background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23ea580c'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1.5rem 1.5rem;
        padding-right: 2.5rem;
    }
</style>
</head>
<body class="bg-amber-50 min-h-screen flex items-center justify-center p-4">

<div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full">
    <h1 class="text-3xl font-extrabold text-center text-orange-600 mb-6 border-b pb-3">
        æ‰¾æ‰¾èŠ’æœå®¶æ—ï½çœ‹ä½ èªå¾—å¹¾å€‹ï¼ğŸ‹
    </h1>

    <!-- éŠæˆ²èªªæ˜å€å¡Š -->
    <div class="game-rules p-4 mb-6 rounded-lg shadow-md text-gray-700">
        <h3 class="text-xl font-bold text-orange-600 mb-2 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.15-.17 2.37-.17 3.52 0C14.49 7.69 15.69 8.67 16.4 10.15c.71 1.48 1.05 3.12 1.05 4.88 0 1.63-.34 3.27-.99 4.75-.65 1.48-1.57 2.53-2.6 3.15-.99.59-2.12.89-3.32.89-1.2 0-2.33-.3-3.32-.89-1.03-.62-1.95-1.67-2.6-3.15-.65-1.48-.99-3.09-.99-4.75 0-1.76.34-3.4 1.05-4.88.71-1.48 1.91-2.46 3.09-2.63z" />
            </svg>
            éŠæˆ²è¦å‰‡ (LLM å¢å¼·ç‰ˆ)
        </h3>
        <ul class="list-disc ml-5 space-y-1 text-sm">
            <li>éŠæˆ²å…±æœ‰ **16 é“é¡Œç›®**ï¼Œé¡Œç›®é †åºæœƒéš¨æ©Ÿè®ŠåŒ–ã€‚</li>
            <li>æ‚¨å°‡çœ‹åˆ°æˆå“¡çš„ç‰¹å¾µæˆ–å–œå¥½ï¼Œè«‹å¾ä¸‹æ–¹çš„**ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡**æ‚¨çŒœæ¸¬çš„åå­—ã€‚</li>
            <li>æ‚¨å¯ä»¥ä½¿ç”¨ **âœ¨ LLM åŠŸèƒ½**ä¾†ç²å–å¹«åŠ©ï¼</li>
        </ul>
    </div>
    <!-- éŠæˆ²èªªæ˜å€å¡ŠçµæŸ -->

    <div id="game" class="space-y-4">
        <div id="clues-container">
            <p class="text-sm font-semibold text-gray-500 mb-2" id="question-count">ç¬¬ 1 / 16 é¡Œ</p>
            <div class="clue bg-yellow-100 p-4 rounded-lg shadow-inner text-gray-800" id="clues">
                <!-- ç·šç´¢å°‡åœ¨é€™è£¡è¼‰å…¥ -->
            </div>
        </div>
        
        <!-- æ–°å¢ LLM åŠŸèƒ½æŒ‰éˆ•å€å¡Š -->
        <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3">
            <button 
                id="tts-button"
                onclick="speakClue()" 
                class="flex items-center justify-center w-full py-2 text-white font-semibold rounded-lg bg-indigo-500 shadow-md transition duration-300 hover:bg-indigo-600 disabled:opacity-50"
            >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25h4.5a.75.75 0 0 0 .75-.75V5.25a.75.75 0 0 0-.75-.75h-4.5a.75.75 0 0 0-.75.75v2.25c0 .414.336.75.75.75Zm-3 5.25H7.5a.75.75 0 0 0 .75-.75V9.75a.75.75 0 0 0-.75-.75H3.75A.75.75 0 0 0 3 9.75v2.25c0 .414.336.75.75.75Zm-.75 3.75a.75.75 0 0 0 .75.75h4.5a.75.75 0 0 0 .75-.75v-2.25c0-.414-.336-.75-.75-.75h-4.5a.75.75 0 0 0-.75.75v2.25Z" />
                </svg>
                âœ¨ å”¸å‡ºç·šç´¢
            </button>
            <button 
                id="explainer-button"
                onclick="getExplanation()" 
                class="flex items-center justify-center w-full py-2 text-white font-semibold rounded-lg bg-purple-500 shadow-md transition duration-300 hover:bg-purple-600 disabled:opacity-50"
            >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z" />
                </svg>
                âœ¨ ç·šç´¢è§£é‡‹å™¨
            </button>
        </div>

        <!-- LLM è¼¸å‡ºå€å¡Šå’Œ TTS Audio Player -->
        <div id="explanation-output" class="p-4 bg-purple-50 rounded-lg border border-purple-200 text-gray-700 text-sm italic" style="display:none;">
            <!-- LLM Explanation will go here -->
        </div>
        <audio id="tts-audio" class="w-full mt-2" style="display:none;" controls></audio>
        <!-- LLM è¼¸å‡ºå€å¡Šå’Œ TTS Audio Player çµæŸ -->
        
        <!-- æ›¿æ›ç‚ºä¸‹æ‹‰å¼é¸å–® -->
        <select
            id="answer_select" 
            class="w-full p-3 border-2 border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 transition duration-300 text-lg"
        >
            <option value="">-- è«‹é¸æ“‡æ‚¨çš„ç­”æ¡ˆ --</option>
            <!-- é¸é …å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
        </select>
        
        <button 
            onclick="checkAnswer()" 
            class="w-full py-3 text-white font-bold rounded-lg bg-orange-500 shadow-md transition duration-330 hover:bg-orange-600"
        >
            æäº¤ç­”æ¡ˆ
        </button>
        
        <div class="message p-3 rounded-lg text-center" id="message">
            <!-- ç­”é¡Œçµæœå°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
    </div>

    <div id="result" class="text-center space-y-4 pt-6" style="display:none;">
        <h2 class="text-4xl font-black text-green-600">ğŸ‰ éŠæˆ²çµæŸï¼ğŸ‰</h2>
        <p class="text-2xl font-bold text-gray-700" id="score"></p>
        <p class="text-lg text-gray-500">æ„Ÿè¬ä½ æŒ‘æˆ°èŠ’æœå®¶æ—å°åµæ¢å¤§å†’éšª ğŸ‹ğŸ˜†</p>
        <button 
            onclick="location.reload()" 
            class="py-2 px-6 text-white font-semibold rounded-full bg-blue-500 hover:bg-blue-600 transition"
        >
            å†ç©ä¸€æ¬¡
        </button>
    </div>
</div>

<script>
// --- èŠ’æœå®¶æ—æˆå“¡çš„æœ€æ–°å®Œæ•´è³‡æ–™ (å…± 16 ä½) ---
let membersData = [
    {name: "èŠ’æœå“¥", clues: ["äººç”Ÿå·²ç¶“é”åˆ°è»ŸQå·”å³°", "å½è…°éƒ½åƒå½ˆåŠ›ç©å…·"]},
    {name: "å°è‹±å§Š", clues: ["æ‹ç…§ç•Œçš„äº¤å‰è…¿æˆ°å£«", "æ¯æ¬¡å‡ºé¡éƒ½å¿…å‚™å‰ªåˆ€è…³å’Œå´èº«æŠ€èƒ½"]},
    {name: "å®£è±å§Š", clues: ["è…¦å­è£¡è£äº†å…¨ä¸–ç•Œäººçš„å–œå¥½è³‡æ–™åº«", "å¥¹è®“ä½ æ‡·ç–‘ï¼šç§’å›ç­”å…¨ä¸–ç•Œå•é¡Œ"]},
    {name: "é˜¿ç¦å“¥", clues: ["å¸¥ï¼‹æ­Œå–‰é›™æŠ€èƒ½", "èµ°è·¯å¸¶BGMçš„å‚³èªªç´šå­˜åœ¨ï¼", "èšæœƒäººæ°£ç‹"]},
    {name: "é™³è‡»è‡»", clues: ["è…¦ä¸­è‡ªå¸¶ TWICE æ­Œæ›²æ’­æ”¾æ¸…å–®", "è½åˆ°æ—‹å¾‹å°±è‡ªå‹•èµ·èˆ"]},
    {name: "é™³å¦¹å¦¹", clues: ["éª¨è£‚ç•Œçš„VIP", "äºŒæ¬¡å…¥å ´åˆ¸å·²é ˜ï¼", "å€‹æ€§è¶…å¼·"]},
    {name: "é™³é˜¿å¡", clues: ["å·¦æ‰‹è½‰é­”æ–¹ï¼Œå³æ‰‹ç”©èˆæ­¥", "å”¯ä¸€èƒ½åŒæ™‚æ‰“ç ´é‡åŠ›å’Œæ™‚é–“çš„åœ‹ä¸­ç”Ÿ"]},
    {name: "ææ­ªé ­", clues: ["äººè¦‹äººæ„›", "ç¬‘å®¹æ²»ç™’", "èšæœƒç„¦é»"]},
    {name: "å°šå‹³å“¥", clues: ["é•·å¾—å¸¥é€£è‡ªæ‹éƒ½å«‰å¦’", "è…¿é•·åˆ°æ‹ç…§ä¸ç”¨è§’åº¦", "é¡é ­éƒ½è‡ªå‹•æ‹‰é "]},
    {name: "æèŠéº»", clues: ["æ´»æ½‘å¯æ„›çš„è‚¥å®…", "å®¶è£¡æœ‰Wi-Fiå’Œè€å©†"]},
    {name: "å²³é˜¿æ–‡", clues: ["æ¼‚äº®ï¼‹æ­Œå–‰ï¼‹é§•é§›æŠ€è¡“", "èµ°åˆ°å“ªéƒ½è‡ªå¸¶æ¼”å”±æœƒï¼‹è»ŠæŠ€è¡¨æ¼”ç§€"]},
    {name: "æè’œçš®", clues: ["æ´»åŠ›ç„¡é™", "åƒæ’äº†å…©ç™¾ä¼ç‰¹é›»æ± ", "æœƒå”±Golden"]},
    {name: "æé˜¿çŸ", clues: ["é‡‘å­—å¡”é ‚å°– VIP åº§ä½", "é€£èšŠå­éƒ½è¦é ç´„æ‰èƒ½æ¥è¿‘", "æ°£å ´å¼·å¤§"]},
    {name: "å»–äº®äº®", clues: ["èˆè¹ˆå¥³ç‹é™è‡¨", "é€£åœ°æ¿éƒ½è¢«è¸©å‡ºç¯€å¥äº†ï¼"]},
    {name: "å»–å…‰å…‰", clues: ["é«˜å¸¥åˆ°é€£å¤©èŠ±æ¿éƒ½æƒ³ä½é ­çœ‹ä»–", "èƒ¸å‰å°æ¼æ–—åƒå°ˆå±¬è¨­è¨ˆ", "è…³æ‰å¾—åƒåœ¨åœ°æ¿ä¸Šè²¼äº†åŠ é€Ÿå™¨"]},
    {name: "å¥é–”å“¥", clues: ["é›²æ—é‡‘åŸæ­¦", "å¤–è¡¨å¸¥æ°£ï¼Œæ°£å ´éå‡¡"]}
];

let totalQuestions = membersData.length;
let members = []; // å¯¦éš›ç”¨æ–¼éŠæˆ²çš„éš¨æ©ŸåŒ–é™£åˆ—
let allNames = membersData.map(m => m.name).sort(); // æ‰€æœ‰åå­—ï¼Œç”¨æ–¼ä¸‹æ‹‰é¸å–®æ’åº

let current = 0;
let score = 0;

// éš¨æ©Ÿæç¬‘æç¤º
const funnyCorrect = ["å¤ªæ£’äº†ï¼ä½ æœç„¶èªå¾—ä»–ï¼ğŸ˜†", "ç­”å°å•¦ï¼å°åµæ¢å¨æ­¦ï¼ğŸ‰", "æ­£ç¢ºï¼èŠ’æœæœƒç‚ºä½ é¼“æŒğŸ‘", "Bingo! é€™æ˜¯ä½ çš„åˆ†æ•¸ï¼ğŸ¥³"];
const funnyWrong = ["å“å‘€ï¼Œç­”éŒ¯äº†ï½å†è©¦ä¸€æ¬¡ï¼ğŸ˜œ", "éŒ¯å•¦ï¼èŠ’æœåœ¨å“­ğŸ˜­", "ä¸å°ä¸å°ï¼å¿«é‡æ–°é›†ä¸­ç²¾ç¥ğŸ’¦", "Opps! è¬é¡Œå¤ªé›£äº†å—ï¼Ÿ"];

// --- Gemini API Configuration ---
const apiKey = ""; 
const GEMINI_TEXT_API = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
const GEMINI_TTS_API = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

// --- Utility Functions for TTS (PCM to WAV conversion) ---

/**
 * å°‡ Base64 å­—ä¸²è½‰æ›ç‚º ArrayBuffer
 */
function base64ToArrayBuffer(base64) {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

/**
 * å°‡ PCM æ•¸æ“šè½‰æ›ç‚º WAV Blob
 * @param {Int16Array} pcm16 - 16ä½æœ‰ç¬¦è™Ÿ PCM æ•¸æ“š
 * @param {number} sampleRate - æ¡æ¨£ç‡
 * @returns {Blob} - WAV æ ¼å¼çš„ Blob
 */
function pcmToWav(pcm16, sampleRate) {
    const numChannels = 1;
    const bitDepth = 16;
    const byteRate = sampleRate * numChannels * (bitDepth / 8);
    const blockAlign = numChannels * (bitDepth / 8);
    
    const buffer = new ArrayBuffer(44 + pcm16.byteLength);
    const view = new DataView(buffer);
    let offset = 0;

    /* å¯«å…¥å­—ä¸² (å››å­—ç¯€) */
    function writeString(s) {
        for (let i = 0; i < s.length; i++) {
            view.setUint8(offset + i, s.charCodeAt(i));
        }
        offset += s.length;
    }

    /* å¯«å…¥ 32 ä½æ•´æ•¸ (å››å­—ç¯€) */
    function writeUint32(i) {
        view.setUint32(offset, i, true);
        offset += 4;
    }

    /* å¯«å…¥ 16 ä½æ•´æ•¸ (å…©å­—ç¯€) */
    function writeUint16(i) {
        view.setUint16(offset, i, true);
        offset += 2;
    }

    // RIFF å€å¡Š
    writeString('RIFF');
    writeUint32(36 + pcm16.byteLength); // ChunkSize
    writeString('WAVE');

    // FMT å€å¡Š
    writeString('fmt ');
    writeUint32(16); // Subchunk1Size (16 for PCM)
    writeUint16(1);  // AudioFormat (1 for PCM)
    writeUint16(numChannels);
    writeUint32(sampleRate);
    writeUint32(byteRate);
    writeUint16(blockAlign);
    writeUint16(bitDepth);

    // DATA å€å¡Š
    writeString('data');
    writeUint32(pcm16.byteLength); // Subchunk2Size
    
    // å¯«å…¥ PCM æ•¸æ“š
    const pcmBytes = new Uint8Array(pcm16.buffer);
    for (let i = 0; i < pcmBytes.length; i++) {
        view.setUint8(offset + i, pcmBytes[i]);
    }

    return new Blob([buffer], { type: 'audio/wav' });
}

/**
 * è™•ç† API å‘¼å«çš„éŒ¯èª¤å’Œé‡è©¦ (æŒ‡æ•¸é€€é¿)
 * @param {Function} apiCall - åŸ·è¡Œ API å‘¼å«çš„å‡½æ•¸
 * @param {number} maxRetries - æœ€å¤§é‡è©¦æ¬¡æ•¸
 * @returns {Promise<Response>}
 */
async function retryFetch(apiCall, maxRetries = 3) {
    let lastError = null;
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await apiCall();
            if (response.ok) {
                return response;
            }
            // å°æ–¼é 2xx ç‹€æ…‹ç¢¼ï¼Œæ‹‹å‡ºéŒ¯èª¤ä»¥è§¸ç™¼é‡è©¦
            throw new Error(`API returned status ${response.status}`);
        } catch (error) {
            lastError = error;
            if (i < maxRetries - 1) {
                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }
    console.error("Gemini API call failed after max retries:", lastError);
    throw lastError;
}

/**
 * Fisher-Yates æ´—ç‰Œæ¼”ç®—æ³•ï¼Œç”¨æ–¼éš¨æ©Ÿæ‰“äº‚æˆå“¡é †åºã€‚
 * @param {Array} array - è¦æ‰“äº‚çš„é™£åˆ—
 */
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]]; // äº¤æ›å…ƒç´ 
    }
}

// --- LLM Feature Functions ---

/**
 * ä½¿ç”¨ Gemini API ç”Ÿæˆç•¶å‰ç·šç´¢çš„å¹½é»˜è§£é‡‹ã€‚
 */
async function getExplanation() {
    const explainerButton = document.getElementById('explainer-button');
    const outputDiv = document.getElementById('explanation-output');
    
    // ç¢ºä¿ç•¶å‰æœ‰é¡Œç›®
    if (current >= totalQuestions) {
         outputDiv.innerHTML = '<p class="text-red-500">éŠæˆ²å·²çµæŸï¼Œè«‹é‡æ–°é–‹å§‹ã€‚</p>';
         outputDiv.style.display = 'block';
         return;
    }

    const currentClues = members[current].clues.join("ï¼Œ");
    const userQuery = `è«‹ä»¥ä¸€ä½é¢¨è¶£ã€äº†è§£æ‰€æœ‰æˆå“¡çš„èŠ’æœå®¶æ—æ•˜äº‹è€…èº«ä»½ï¼Œæ ¹æ“šä»¥ä¸‹ç·šç´¢ï¼Œæä¾›ä¸€æ®µ 2-3 å¥è©±ï¼Œæ¥µå…·æˆ²åŠ‡æ€§å’Œå¨›æ¨‚æ€§çš„è§’è‰²è§£é‡‹ï¼Œä½†**ä¸èƒ½æåˆ°æˆå“¡çš„åå­—**ã€‚ç·šç´¢ï¼š${currentClues}`;
    const systemPrompt = "ä½ æ˜¯ä¸€ä½ç†±æƒ…ã€é¢¨è¶£çš„ã€èŠ’æœå®¶æ—ã€å•ç­”éŠæˆ²æ•˜äº‹è€…ã€‚ä½ çš„ä»»å‹™æ˜¯æ”¾å¤§ç·šç´¢ä¸­çš„æˆ²åŠ‡æ€§ï¼Œä¸¦ä»¥å¨›æ¨‚çš„å£å»å°ç·šç´¢é€²è¡Œè§£é‡‹ã€‚ä½ çš„å›ç­”å¿…é ˆæ˜¯ç¹é«”ä¸­æ–‡ï¼Œä¸”é•·åº¦éœ€ç°¡æ½”ï¼ˆ2-3 å¥è©±ï¼‰ã€‚";

    // è¨­ç½® loading ç‹€æ…‹
    explainerButton.disabled = true;
    explainerButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> æ­£åœ¨ç”Ÿæˆè§£é‡‹...`;
    outputDiv.style.display = 'block';
    outputDiv.innerHTML = '<p class="text-center text-purple-500">æ­£åœ¨å¬å–šèŠ’æœæ•˜äº‹è€…...</p>';

    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
    };

    try {
        const response = await retryFetch(() => fetch(GEMINI_TEXT_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }));
        
        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œç„¡æ³•ç”Ÿæˆè§£é‡‹ã€‚è«‹å†è©¦ä¸€æ¬¡ã€‚";

        outputDiv.innerHTML = `<p class="font-bold text-purple-700 mb-1">èŠ’æœæ•˜äº‹è€…ï¼š</p><p>${text}</p>`;

    } catch (e) {
        outputDiv.innerHTML = `<p class="text-red-500">é€£ç·šéŒ¯èª¤æˆ– API å‘¼å«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚`;
    } finally {
        explainerButton.disabled = false;
        explainerButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z" /></svg> âœ¨ ç·šç´¢è§£é‡‹å™¨`;
    }
}


/**
 * ä½¿ç”¨ Gemini TTS API è®€å‡ºç•¶å‰ç·šç´¢ã€‚
 */
async function speakClue() {
    const ttsButton = document.getElementById('tts-button');
    const audioPlayer = document.getElementById('tts-audio');
    const outputDiv = document.getElementById('explanation-output');

    // ç¢ºä¿ç•¶å‰æœ‰é¡Œç›®
    if (current >= totalQuestions) {
         outputDiv.innerHTML = '<p class="text-red-500">éŠæˆ²å·²çµæŸï¼Œè«‹é‡æ–°é–‹å§‹ã€‚</p>';
         outputDiv.style.display = 'block';
         return;
    }

    const currentClueText = members[current].clues.join("ã€‚");
    // è«‹ç”¨è¼•é¬†æ„‰å¿«çš„èªæ°£ï¼Œä»¥å°ç£ä¸­æ–‡çš„èªèª¿ï¼Œè®€å‡ºä»¥ä¸‹ç·šç´¢ï¼š
    const ttsPrompt = `è«‹ç”¨è¼•é¬†æ„‰å¿«çš„èªæ°£è®€å‡ºä»¥ä¸‹ç·šç´¢ï¼š${currentClueText}`;

    // è¨­ç½® loading ç‹€æ…‹
    ttsButton.disabled = true;
    ttsButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> æ­£åœ¨ç”ŸæˆèªéŸ³...`;
    outputDiv.style.display = 'block';
    outputDiv.innerHTML = '<p class="text-center text-indigo-500">æ­£åœ¨ç”ŸæˆèªéŸ³ç·šç´¢...</p>';
    audioPlayer.style.display = 'none'; // éš±è—æ’­æ”¾å™¨ç›´åˆ°æº–å‚™å¥½

    const payload = {
        contents: [{ parts: [{ text: ttsPrompt }] }],
        generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: {
                voiceConfig: {
                    prebuiltVoiceConfig: { voiceName: "Puck" } // Upbeat voice
                }
            }
        },
        model: "gemini-2.5-flash-preview-tts"
    };

    try {
        const response = await retryFetch(() => fetch(GEMINI_TTS_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }));
        
        const result = await response.json();
        const part = result?.candidates?.[0]?.content?.parts?.[0];
        const audioData = part?.inlineData?.data;
        const mimeType = part?.inlineData?.mimeType;

        if (audioData && mimeType && mimeType.startsWith("audio/")) {
            const sampleRateMatch = mimeType.match(/rate=(\d+)/);
            if (!sampleRateMatch) throw new Error("Sample rate not found in MIME type.");
            const sampleRate = parseInt(sampleRateMatch[1], 10);
            
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, sampleRate);
            const audioUrl = URL.createObjectURL(wavBlob);
            
            audioPlayer.src = audioUrl;
            audioPlayer.style.display = 'block';
            audioPlayer.play();
            
            outputDiv.innerHTML = `<p class="text-center text-indigo-700">èªéŸ³å·²æº–å‚™å¥½æ’­æ”¾ï¼ğŸ§</p>`;
        } else {
            throw new Error("Invalid audio data or response structure.");
        }
    } catch (e) {
        console.error(e);
        outputDiv.innerHTML = `<p class="text-red-500">èªéŸ³ç”Ÿæˆå¤±æ•—ï¼š${e.message || 'é€£ç·šéŒ¯èª¤'}ã€‚`;
    } finally {
        ttsButton.disabled = false;
        ttsButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25h4.5a.75.75 0 0 0 .75-.75V5.25a.75.75 0 0 0-.75-.75h-4.5a.75.75 0 0 0-.75.75v2.25c0 .414.336.75.75.75Zm-3 5.25H7.5a.75.75 0 0 0 .75-.75V9.75a.75.75 0 0 0-.75-.75H3.75A.75.75 0 0 0 3 9.75v2.25c0 .414.336.75.75.75Zm-.75 3.75a.75.75 0 0 0 .75.75h4.5a.75.75 0 0 0 .75-.75v-2.25c0-.414-.336-.75-.75-.75h-4.5a.75.75 0 0 0-.75.75v2.25Z" /></svg> âœ¨ å”¸å‡ºç·šç´¢`;
    }
}


/**
 * é¡¯ç¤ºç•¶å‰æˆå“¡çš„ç·šç´¢ä¸¦å¡«å……ä¸‹æ‹‰é¸å–®ã€‚
 */
function showClues() {
    // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰é¡Œç›®éƒ½å·²å®Œæˆ
    if (current >= totalQuestions) {
        showResult();
        return;
    }

    const clueDiv = document.getElementById('clues');
    const questionCount = document.getElementById('question-count');
    const selectElement = document.getElementById('answer_select');

    // 1. æ›´æ–°å•é¡Œè¨ˆæ•¸
    questionCount.innerText = `ç¬¬ ${current + 1} / ${totalQuestions} é¡Œ`;

    // 2. é¡¯ç¤ºç·šç´¢
    clueDiv.innerHTML = "";
    members[current].clues.forEach((c, i) => {
        clueDiv.innerHTML += `<p class="${i > 0 ? 'mt-2' : ''} text-base">**ç·šç´¢ ${i + 1}:** ${c}</p>`;
    });

    // 3. å¡«å……ä¸‹æ‹‰é¸å–®
    selectElement.innerHTML = '<option value="" disabled selected>-- è«‹é¸æ“‡æ‚¨çš„ç­”æ¡ˆ --</option>'; // é‡ç½®ä¸¦æ·»åŠ é è¨­é¸é …
    
    // éæ­·æ‰€æœ‰æˆå“¡åç¨±ï¼Œæ·»åŠ åˆ°ä¸‹æ‹‰é¸å–®ä¸­
    allNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.text = name;
        selectElement.appendChild(option);
    });
    
    // 4. æ¸…ç©ºæç¤ºè¨Šæ¯å’Œ LLM è¼¸å‡ºå€
    document.getElementById('message').innerText = "";
    document.getElementById('message').className = "message p-3 rounded-lg text-center";
    
    // é‡ç½® LLM å€åŸŸ
    document.getElementById('explanation-output').style.display = 'none';
    document.getElementById('explanation-output').innerHTML = '';
    const audioPlayer = document.getElementById('tts-audio');
    audioPlayer.pause();
    audioPlayer.src = '';
    audioPlayer.style.display = 'none';
    
    // 5. å°‡ç„¦é»ç§»å›é¸å–®
    selectElement.focus();
}

/**
 * æª¢æŸ¥ä½¿ç”¨è€…æäº¤çš„ç­”æ¡ˆæ˜¯å¦æ­£ç¢ºã€‚
 */
function checkAnswer() {
    // é˜²æ­¢é‡è¤‡é»æ“Šï¼Œå…ˆç¦ç”¨æŒ‰éˆ•
    const submitButton = document.querySelector('button[onclick="checkAnswer()"]');
    const explainerButton = document.getElementById('explainer-button');
    const ttsButton = document.getElementById('tts-button');

    submitButton.disabled = true;
    explainerButton.disabled = true;
    ttsButton.disabled = true;

    const selectElement = document.getElementById('answer_select');
    const userAnswer = selectElement.value; // ç›´æ¥ç²å–é¸ä¸­çš„å€¼
    const messageDiv = document.getElementById('message');
    const correctAnswer = members[current].name;

    if (userAnswer === "") {
        messageDiv.innerText = "è«‹é¸æ“‡ä¸€å€‹æˆå“¡åç¨±ï¼";
        messageDiv.className = "message p-3 rounded-lg text-center bg-yellow-200 text-yellow-800";
        submitButton.disabled = false;
        explainerButton.disabled = false;
        ttsButton.disabled = false;
        return;
    }
    
    // ç›´æ¥æ¯”å°é¸ä¸­çš„å€¼å’Œæ­£ç¢ºç­”æ¡ˆï¼ˆå› ç‚ºä¸‹æ‹‰é¸å–®çš„å€¼æ˜¯ä¹¾æ·¨çš„ï¼‰
    if (userAnswer === correctAnswer) {
        // ç­”å°é‚è¼¯
        messageDiv.innerHTML = `âœ… **ç­”å°å•¦ï¼** ${correctAnswer}ï¼ ${funnyCorrect[Math.floor(Math.random() * funnyCorrect.length)]}`;
        messageDiv.className = "message p-3 rounded-lg text-center bg-green-200 text-green-800";
        score++;
    } else {
        // ç­”éŒ¯é‚è¼¯
        messageDiv.innerHTML = `âŒ **ç­”éŒ¯å•¦ï¼** ${funnyWrong[Math.floor(Math.random() * funnyWrong.length)]}<br>æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<span class="font-black text-red-600">${correctAnswer}</span>`;
        messageDiv.className = "message p-3 rounded-lg text-center bg-red-200 text-red-800";
    }

    current++;

    if (current < totalQuestions) {
        // ç­”é¡Œå¾Œç­‰å¾… 2 ç§’é¡¯ç¤ºä¸‹ä¸€é¡Œ
        setTimeout(() => {
            showClues();
            submitButton.disabled = false; // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
            explainerButton.disabled = false;
            ttsButton.disabled = false;
        }, 2000);
    } else {
        // ç­”å®Œæ‰€æœ‰é¡Œç›®å¾Œé¡¯ç¤ºçµæœ
        setTimeout(showResult, 2000);
    }
}

/**
 * é¡¯ç¤ºéŠæˆ²çµæœã€‚
 */
function showResult() {
    document.getElementById('game').style.display = "none";
    document.getElementById('result').style.display = "block";
    document.getElementById('score').innerText = `ä½ ç¸½å…±ç­”å° ${score} / ${totalQuestions} ä½èŠ’æœå®¶æ—æˆå“¡ï¼`;
}

// --- å•Ÿå‹•éŠæˆ²ï¼šç¢ºä¿åœ¨ DOM å…§å®¹è¼‰å…¥å®Œç•¢å¾Œæ‰åŸ·è¡Œ ---
document.addEventListener('DOMContentLoaded', () => {
    // 1. éš¨æ©Ÿæ‰“äº‚æˆå“¡é †åºï¼Œä½œç‚ºéŠæˆ²çš„é¡Œç›®é †åº
    members = [...membersData]; // è¤‡è£½ä¸€ä»½
    shuffleArray(members); 
    
    // 2. é¡¯ç¤ºç¬¬ä¸€çµ„ç·šç´¢ä¸¦å¡«å……ä¸‹æ‹‰é¸å–®
    showClues();
});
</script>

</body>
</html>
